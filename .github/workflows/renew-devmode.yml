name: Renew LG TV Dev Mode

on:
  schedule:
    # Chạy mỗi giờ (0 phút của mỗi giờ) — bạn có thể đổi thành '0 0 * * 1' để chạy mỗi thứ Hai lúc 0h
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  renew_session:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Cần quyền ghi để push log
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send renewal request & log result
        env:
          LG_TOKEN: ${{ secrets.LG_DEVMODE_TOKEN }}
        run: |
          # Tạo timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Gửi request gia hạn
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/response_body "https://developer.lge.com/secure/ResetDevModeSession.dev?sessionToken=$LG_TOKEN")
          HTTP_STATUS=$RESPONSE
          BODY=$(cat /tmp/response_body)

          # Tạo nội dung log
          LOG_ENTRY="[$TIMESTAMP] HTTP $HTTP_STATUS | Token: ${LG_TOKEN:0:8}... | Response: $BODY"

          # Ghi vào log.txt (nếu file chưa tồn tại thì tạo mới)
          echo "$LOG_ENTRY" >> log.txt

          echo "Đã ghi log: $LOG_ENTRY"

      - name: Commit and push log.txt
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add log.txt
          git commit -m "Auto update log: $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push
